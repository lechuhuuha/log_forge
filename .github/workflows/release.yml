name: release

on:
  push:
    tags:
      - "v*"

permissions:
  contents: write
  packages: write
  pull-requests: write

env:
  REGISTRY: ghcr.io

jobs:
  build-and-publish:
    runs-on: ubuntu-latest
    outputs:
      image_repo: ${{ steps.image.outputs.repo }}
      image_tag: ${{ steps.meta.outputs.version }}
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Go
        uses: actions/setup-go@v5
        with:
          go-version-file: go.mod
          cache: true

      - name: Build metadata
        id: meta
        run: |
          echo "version=${GITHUB_REF_NAME}" >> "$GITHUB_OUTPUT"
          echo "build_date=$(date -u +%Y-%m-%dT%H:%M:%SZ)" >> "$GITHUB_OUTPUT"

      - name: Build release binary with ldflags
        run: |
          mkdir -p bin
          go build \
            -ldflags "-X main.Version=${{ steps.meta.outputs.version }} -X main.Commit=${GITHUB_SHA} -X main.BuildDate=${{ steps.meta.outputs.build_date }}" \
            -o bin/server ./cmd

      - name: Image repository
        id: image
        run: |
          repo="$(echo "${GITHUB_REPOSITORY}" | tr '[:upper:]' '[:lower:]')"
          echo "repo=${REGISTRY}/${repo}" >> "$GITHUB_OUTPUT"

      - name: Login to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Setup Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: Build and push image
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: |
            ${{ steps.image.outputs.repo }}:${{ steps.meta.outputs.version }}
            ${{ steps.image.outputs.repo }}:latest
          build-args: |
            BUILD_VERSION=${{ steps.meta.outputs.version }}
            BUILD_COMMIT=${{ github.sha }}
            BUILD_DATE=${{ steps.meta.outputs.build_date }}

  update-dev-and-staging-values:
    runs-on: ubuntu-latest
    needs: build-and-publish
    steps:
      - name: Checkout default branch
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.repository.default_branch }}

      - name: Update dev and staging image tags
        run: |
          sed -i -E "s|^([[:space:]]*tag:[[:space:]]*).*$|\\1${GITHUB_REF_NAME}|" deploy/env/dev/values.yaml
          sed -i -E "s|^([[:space:]]*tag:[[:space:]]*).*$|\\1${GITHUB_REF_NAME}|" deploy/env/staging/values.yaml

      - name: Create PR for dev and staging tag update
        uses: peter-evans/create-pull-request@v6
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          branch: chore/dev-staging-image-${{ github.ref_name }}
          delete-branch: true
          commit-message: "chore: bump dev and staging image to ${{ github.ref_name }}"
          title: "chore: bump dev and staging image to ${{ github.ref_name }}"
          body: |
            Update dev and staging image tags after release `${{ github.ref_name }}`.

            Image: `${{ needs.build-and-publish.outputs.image_repo }}:${{ needs.build-and-publish.outputs.image_tag }}`
          base: ${{ github.event.repository.default_branch }}
